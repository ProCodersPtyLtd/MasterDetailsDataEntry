@inject IComponentTypeResolver _componentResolverService

<div class="RepeaterDataControl">
    <table mat-table>
        <tr class="jsgrid-grid-header">
            @foreach (var field in Fields)
            {
                @if (field.Hidden)
                {
                    continue;
                }

                @if (field.Required)
                {
                    <th>@(field.Label)*</th>
                }
                else
                {
                    <th>@field.Label</th>
                }
            }

            <th></th>
        </tr>

        @{
            @*@foreach (var item in ModelItems)*@
            @for (int rowIndex = 0; rowIndex < ModelItems.Count; rowIndex++)
            {
                var row = rowIndex;

                <tr class="jsgrid-row-item">
                    @foreach (var field in Fields)
                    {
                        @if (field.Hidden)
                        {
                            continue;
                        }

                        <td>
                            <SingleDataControl Form="@Form" Field="@field" IsEditing="GetRowState(rowIndex).IsEditing" State="@CreateFieldState(field, rowIndex)"
                                               ModelValueChanged="@LocalModelValueChanged" />
                        </td>
                    }

                    <td>
                        <button class="btn btn-light" title="Edit" @onclick="@((args) => EditClick(args, row))" hidden="@(GetRowState(rowIndex).IsEditing)" disabled="@_isEditing">
                            <span class="oi oi-pencil"></span>
                        </button>

                        <button class="btn btn-light" titel="Delete"
                                @onclick="@((args) => DeleteClick(args, row))" hidden="@(GetRowState(rowIndex).IsEditing)" disabled="@_isEditing">
                            <span class="oi oi-delete"></span>&nbsp;
                        </button>

                        <button class="btn btn-light" title="Apply" @onclick="@((args) => ApplyClick(args, row))" hidden="@(!GetRowState(rowIndex).IsEditing)">
                            <span class="oi oi-check"></span>
                        </button>

                        <button class="btn btn-light" title="Cancel" @onclick="@((args) => CancelClick(args, row))" hidden="@(!GetRowState(rowIndex).IsEditing)">
                            <span class="oi oi-action-undo"></span>
                        </button>
                    </td>
                </tr>
            }
        }

    </table>
    <div>
        <button class="btn btn-primary" @onclick="@((args) => AddClick(args))" disabled="@_isEditing">Add</button>
    </div>

    <textarea hidden="@(_error == null ? "hidden" : null)" readonly="readonly" class="form-control" style="background-color: black; color: red;" rows="3">Error: @_error</textarea>
</div>

@code
{
    [Parameter]
    public bool FullRefresh { get; set; }


    [Parameter]
    public IModelDefinitionForm Form { get; set; }

    [Parameter]
    public Type ModelType { get; set; }

    [Parameter]
    public IEnumerable<DataField> Fields { get; set; }

    [Parameter]
    public System.Collections.IList ModelItems { get; set; }

    [Parameter]
    public EventCallback<ValueChangedArgs> ModelValueChanged { get; set; }

    [Parameter]
    public EventCallback<ItemsChangedArgs> ItemsChanged { get; set; }

    private object _modelItemReserveCopy;
    private bool _isEditing;
    private string _error;

    protected override void OnInitialized()
    {
        base.OnInitialized();

        _isEditing = false;
        _modelItemReserveCopy = null;
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        if (FullRefresh)
        {
            _isEditing = false;
            _modelItemReserveCopy = null;
            FullRefresh = false;
        }
    }

    private EditModes GetEditMode()
    {
        return EditModes.SingleRecord;
    }

    private async Task LocalModelValueChanged(ValueChangedArgs args)
    {
        SetItemValue(args.Field, args.State);
        await ModelValueChanged.InvokeAsync(args);
    }

    private FieldState CreateFieldState(DataField field, int row)
    {
        var result = new FieldState(field, row);
        result.Value = GetItemValue(field, row);
        return result;
    }

    private object GetItemValue(DataField field, int row)
    {
        var item = ModelItems[row];
        var result = item.GetPropertyValue(field.BindingProperty);
        return result;
    }

    private void SetItemValue(DataField field, FieldState state)
    {
        var item = ModelItems[state.RowIndex];
        item.SetPropertyValue(field.BindingProperty, state.Value);
    }

    private RowState GetRowState(int rowIndex)
    {
        return ModelItems[rowIndex].GetBag<RowState>();
    }

    private void EditClick(MouseEventArgs e, int rowIndex)
    {
        _isEditing = true;
        ModelItems[rowIndex].GetBag<RowState>().IsEditing = true;
        _modelItemReserveCopy = ModelItems[rowIndex].GetCopy();
        StateHasChanged();
    }

    private void DeleteClick(MouseEventArgs e, int rowIndex)
    {
        var args = new ItemsChangedArgs { Operation = ItemOperations.Delete, RowIndex = rowIndex };
        ItemsChanged.InvokeAsync(args);
    }

    private async Task ApplyClick(MouseEventArgs e, int rowIndex)
    {
        _error = null;
        var args = new ItemsChangedArgs { Operation = ItemOperations.Update, RowIndex = rowIndex };

        try
        {
            await ItemsChanged.InvokeAsync(args);
        }
        catch(Exception exc)
        {
            _error = exc.Message;

            if (exc.InnerException != null)
            {
                _error += "\r\n";
                _error += exc.InnerException.Message;
            }

            StateHasChanged();
        }

        if (_error == null)
        {
            ModelItems[rowIndex].GetBag<RowState>().IsEditing = false;
            ModelItems[rowIndex].GetBag<RowState>().IsNew = false;
            _isEditing = false;
        }
    }

    private void CancelClick(MouseEventArgs e, int rowIndex)
    {
        _error = null;
        _modelItemReserveCopy.CopyTo(ModelItems[rowIndex]);
        ModelItems[rowIndex].GetBag<RowState>().IsEditing = false;
        _isEditing = false;

        if (ModelItems[ModelItems.Count - 1].GetBag<RowState>().IsNew)
        {
            ModelItems.RemoveAt(ModelItems.Count - 1);
        }
    }

    private void AddClick(MouseEventArgs e)
    {
        var item = Activator.CreateInstance(ModelType);
        ModelItems.Add(item);
        EditClick(null, ModelItems.Count-1);
        ModelItems[ModelItems.Count - 1].GetBag<RowState>().IsNew = true;
    }


}